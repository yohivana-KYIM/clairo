const translations = {
    request_date: "Date de la demande",
    company_name: "Nom de l'entreprise",
    address: "Adresse",
    postal_code: "Code postal",
    city: "Ville",
    country: "Pays",
    siren: "SIREN",
    naf: "Code NAF",
    siret: "SIRET",
    vat_number: "Numéro de TVA",
    access_duration: "Durée d'accès",
    access_type: "Type d'accès",
    duplicate_reason: "Motif du duplicata",
    access_locations: "Sites d'accès",
    fos: "Fos-sur-Mer",
    lavera: "Lavera",
    access_purpose: "Motif de l'accès",
    security_officer_name: "Nom du responsable sécurité",
    security_officer_position: "Fonction du responsable sécurité",
    security_officer_email: "Email du responsable sécurité",
    security_officer_phone: "Téléphone du responsable sécurité",

    gender: "Sexe",
    employee_first_name: "Prénom de l'employé",
    employee_last_name: "Nom de l'employé",
    maiden_name: "Nom de jeune fille",
    employee_birthdate: "Date de naissance",
    employee_birthplace: "Lieu de naissance",
    employee_birth_postale_code: "Code postal de naissance",
    employee_birth_district: "Département de naissance",
    nationality: "Nationalité",
    social_security_number: "Numéro de sécurité sociale",
    employee_email: "Email de l'employé",
    employee_phone: "Téléphone de l'employé",
    employee_refugee: "Est t'il refugié?",
    refugee: "OUI",

    employee_address_autocomplete: "Adresse de l'employé (auto-complétion)",
    section_employee_address: "Adresse de l'employé",
    resident_situation: "Situation de résidence",
    father_name: "Nom du père",
    father_first_name: "Prénom du père",
    mother_maiden_name: "Nom de jeune fille de la mère",
    mother_first_name: "Prénom de la mère",
    contract_type: "Type de contrat",
    employee_function: "Fonction de l'employé",
    employment_date: "Date de début de contrat",
    contract_end_date: "Fin de contrat",

    "Certifications et qualifications": "Certifications et qualifications",
    fluxel_training: "Formation Fluxel",
    gies_1: "GIES 1",
    gies_2: "GIES 2",
    atex_0: "ATEX 0",
    zar: "ZAR",
    health: "Visite médicale",

    id_card: "Carte d'identité",
    passport: "Passeport",
    photo: "Photo",
    proof_of_address_host: "Justificatif d'hébergement",
    zar_decision: "Décision ZAR",
    doc_ates_0: "Document ATEX 0",
    doc_atex_0: "Document ATEX 0",
    doc_gies_1: "Document GIES 1",
    doc_gies_2: "Document GIES 2",
    health_attestation: "Attestation médicale",
    taxi_card: "Carte de taxi",
    general_conditions: "Conditions générales",
    accept_terms: "J'accepte les conditions",
    card_place: "Lieu de délivrance du badge",
    observations: "Observations",
    access_duration_duplicate: "Durée d'accès (duplicata)",
    access_decision: "Décision",
    owner_or_renter:"Propriétaire ou locataire",
    responsible_name:"Nom du responsable",
    security_email:"Email du responsable sécurité",
    security_phone:"Téléphone du responsable sécurité",
    siren_number:"Numéro SIREN",
    naf_number:"Code NAF",
    ape_code:"Code APE",
    siret_number:"Numéro SIRET",
    email:"Email",
    registration_number:"Immatriculation",
    brand:"Marque",
    model:"Modèle",
    first_registration_date:"Date de première immatriculation",
    vehicle_type:"Type de véhicule",
    certification_type:"Type de certification",
    gies_expiry_date:"Date d’expiration GIES",
    fos_port_access:"Accès port de Fos",
    lavera_port_access:"Accès port de Lavera",
    fos_access_reason:"Motif d’accès Fos",
    lavera_access_reason:"Motif d’accès Lavera",
    signature:"Signature",
    card_copy:"Copie de la carte",
    gies_sticker_copy:"Copie du sticker GIES",
    terms_and_conditions:"Engagement et pièces jointes",
    upload_signature: "Télécharger",
    vehicle_step_one: "Informations sur la demande",
    person_step_one: "Informations sur la demande",
    vehicle_step_two: "Informations sur le véhicule",
    person_step_two: "Informations sur l'employé",
    vehicle_step_three: "Accès souhaité",
    person_step_three: "Certifications et qualifications",
    vehicle_step_five: "Pièces jointes",
    person_step_five: "Pièces jointes",
    vehicle_step_six: "Engagement et pièces jointes",
    person_step_six: "Engagement et pièces jointes",
    draft: "Brouillon",
    deposit: "Déposé",
    awaiting_reference: "En attente de référence",
    pending: "En attente de révision",
    awaiting_info: "En attente d'informations",
    provisioned: "Accès temporaire accordé",
    approved: "Approuvé",
    reopen_case: "Rouvrir le dossier",
    needs_clarification: "Demander des précisions",
    refused: "Refusé",
    awaiting_payment: "En attente de paiement",
    paid: "Payé",
    bad_firm: "Entreprise interdite",
    card_edited: "Carte éditée",
    card_delivered: "Carte livrée",
    submit: "Soumettre",
    await_reference: "Notifier referent",
    start_review: "Il est de mon entreprise",
    request_more_info: "Demander plus d'informations",
    provide_temp_access: "Fournir un accès temporaire",
    approve: "Approuver la demande",
    reject: "Rejeter",
    request_payment: "Panier",
    reedit_card: "Rééditer la carte",
    confirm_payment: "Confirmer le paiement",
    mark_bad_firm: "Personne non reconnue",
    edit_card: "Imprimer la carte",
    deliver_card: "Livrer la carte",
    prepare_technical_record: "Préparer le dossier SNEAS",
    microcesame_error: "Erreur MicroCESAME",
    correct_microcesame: "Corriger MicroCESAME",
    launch_preliminary_investigation: "Lancer l'enquête préalable",
    investigation_rejected: "Rejet de l'enquête préalable",
    relaunch_investigation: "Relancer",
    validate_investigation: "Valider l'enquête",
    cerbere_sync: "Envoyer à CERBERE",
    cerbere_failure: "Erreur d'envoi CERBERE",
    retry_cerbere: "Réessayer l’envoi CERBERE",
    cerbere_return: "Retour de CERBERE",
    numero_cni: "Numero de CNI/Passeport",
    microcesame:"Dossier technique en cours",
    enquete_prealable:"Enquête préalable",
    tc_temp_ok:"Validation technique OK",
    tc_temp_ko:"Échec validation technique",
    cerbere_sent:"Envoyé à Cerbère",
    cerbere_ok:"Retour Cerbère OK",
    reset_investigation:"Réinitialiser l'enquête",
    microcesame_ko: "Erreur MicroCESAME",
    investigation_ko: "Enquête préalable rejetée",
    cerbere_ko: "Erreur CERBERE",
    payment_doc_ko: "Erreur de document de paiement",
    section_mandatory: "Pièces justificatives obligatoires",
    residence_permit: "Carte ou Titre de séjour (recto et verso)",
    resident_id_card: "Carte d'identité de l'hébergeant (recto et verso)",
    section_optionnal: "Pièces supplémentaires",
    resident_letter: "Attestation d'hébergement (moins de 3 mois)",
    proof_of_address_hosted: "Justificatif de domicile de l'hébergeant (moins de 3 mois)",
    loss_declaration: "Déclaration de perte/vol du titre de circulation",
    section_specific_cases: "Documents spécifiques",
    birth_certificate: "Extrait d'acte de naissance avec filiation (nés à l'étranger)",
    criminal_record_origin: "Casier judiciaire du pays d'origine",
    criminal_record_nationality: "Casier judiciaire du pays de la nationalité",
    criminal_record_resident_country: "Casier judiciaire du pays de résidence actuel",
    refugee_attestation: "Attestation de l'OFPRA",
    refugee_criminal_record: "Casier judiciaire national post-réfugié",
    section_ask_infos: "Informations générales",
    enterprise_autocomplete: "Entreprise",
    section_address: "Coordonnées de la société",
    section_enterprise: "Entreprise",
    section_mandatory_access: "Accès requis",
    section_refsec: "Référent Sûreté",
    section_employee_infos: "Identité de l’employé",
    matricule: "Matricule",
    section_parents: "Parents",
    section_contract: "Contrat",
    section_demandeur: "Demandeur",
    section_localisation: "Localisation",
    section_entreprise: "Entreprise",
    old_circulation_card: "Ancien titre de circulation",
    declaration_form: "Formulaire de déclaration de perte, casse ou vol",
    hq: "Siège social",
    alternate_referent_name: "Contact de secours — nom",
    alternate_referent_position: "Contact de secours — fonction",
    alternate_referent_email: "Contact de secours — email",
    alternate_referent_phone: "Contact de secours — téléphone",
    employee_last_name_2: "Deuxième prenom",
    employee_last_name_3: "Troisième prenom",
    employee_last_name_4: "Quatrième prenom",
    cni_type: "Type de pièce d'identité",
    no_card_found: "Carte non trouvé",
    access_expiration_date: "Durée de validité de l'accès",
};

document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.getAttribute('data-i18n');
    if (translations[key]) {
        el.innerText = translations[key];
    }
});

const reviewItems = document.querySelectorAll(".review-item-value");

reviewItems.forEach(item => {
    const field = item.dataset.field;
    let value = item.innerHTML.trim();

    // Ignore <ul>, <a>, <em> or complex HTML content
    if (item.querySelector("ul, a, em")) return;

    // Format date fields (YYYY-MM-DD to DD/MM/YYYY)
    const dateRegex = /^\d{4}-\d{2}-\d{2}$/;
    if (dateRegex.test(value)) {
        const [y, m, d] = value.split("-");
        value = `${d}/${m}/${y}`;
    }

    // Handle booleans or binary values
    if (value === "1") value = "Oui";
    else if (value === "0") value = "Non";

    // Handle base64 decoding (e.g. for access_purpose)
    if (field === "access_purpose") {
        try {
            const decoded = atob(value);
            if (decoded.match(/^[\x20-\x7E\s]+$/)) {
                value = decoded;
            }
        } catch (e) {
            // console.warn("Invalid base64 for", field);
        }
    }

    // Handle empty fields
    if (!value || value === "&nbsp;" || value === "") {
        value = "<em>Non renseigné</em>";
    }

    // Format known number types
    const numbersOnly = value.replace(/\D/g, '');

    if (field === "siren" && numbersOnly.length === 9) {
        value = numbersOnly.replace(/(\d{3})(\d{3})(\d{3})/, "$1 $2 $3");
    }
    else if (field === "siret" && numbersOnly.length === 14) {
        value = numbersOnly.replace(/(\d{3})(\d{3})(\d{3})(\d{5})/, "$1 $2 $3 $4");
    }
    else if (field === "social_security_number" && numbersOnly.length === 15) {
        value = numbersOnly.replace(/(\d{1})(\d{2})(\d{2})(\d{3})(\d{3})(\d{3})(\d{1})/, "$1 $2 $3 $4 $5 $6 $7");
    }
    else if (field.includes("phone") && numbersOnly.length === 10) {
        value = numbersOnly.replace(/(\d{2})(\d{2})(\d{2})(\d{2})(\d{2})/, "$1 $2 $3 $4 $5");
    }

    // Capitalize simple strings (like "first", "mme", "cdi")
    if (value.match(/^[a-zàâçéèêëîïôûùüÿñæœ\s\-']+$/i)) {
        value = value.charAt(0).toUpperCase() + value.slice(1).toLowerCase();
    }

    // Traductions personnalisées pour certaines valeurs de champ
    const fieldTranslations = {
        resident_situation: {
            owner_or_tenant: "Propriétaire ou locataire",
            hosted: "Hébergé(e)"
        },
        gender: {
            mme: "Madame",
            mr: "Monsieur"
        },
        contract_type: {
            cdi: "CDI",
            cdd: "CDD",
            interim: "Intérim"
        },
        access_type: {
            first: "Première demande",
            renewal: "Renouvellement"
        }
    };

    if (fieldTranslations[field] && fieldTranslations[field][value.toLowerCase()]) {
        value = fieldTranslations[field][value.toLowerCase()];
    }

    item.innerHTML = value;
});

document.addEventListener('DOMContentLoaded', () => {
    // Find all the wrapper spans whose textContent is an HTML-escaped <span class="encoded-content">…</span>
    document.querySelectorAll('.review-item-value').forEach(wrapper => {
        // Get the raw text, e.g. '<span class="encoded-content">PHA+…=</span>'
        const raw = wrapper.textContent.trim();
        // Parse it into actual DOM so we can select the inner encoded span
        const tmp = document.createElement('div');
        tmp.innerHTML = raw;
        const enc = tmp.querySelector('.encoded-content');
        if (enc) {
            // Decode the Base64 payload
            const decodedHtml = atob(enc.textContent);
            // Replace the wrapper’s contents with the decoded HTML
            wrapper.innerHTML = decodedHtml;
        }
    });
});