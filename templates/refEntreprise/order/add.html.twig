{% extends 'base.html.twig' %}

{% block title %}Vérifier ma commande{% endblock %}

{% block body %}
  <div class="container">
    <div class="container-title">Veuillez vérifier votre commande avant de procéder au paiement.</div>
    <hr>
    <div class="row">
      <div class="col-md-6">
          <h4 class="mt-4">Adresse de l'entreprise</h4>
            <div class="mt-1 mb-3 ms-2 fs-5">
              {{ entreprise.nom }} <br>
              {{ entreprise.adresse }} <br>
              {{ entreprise.codePostal }}
              {{ entreprise.ville }}
              {{ entreprise.pays }}
            </div>
          <h4>Adresse de facturation</h4>
          <div class="mt-1 mb-3 ms-2 fs-5">
          {% if entreprise.adresse != null %}
              {{ entreprise.nom }} <br>
              {{ entreprise.adresse }} <br>
              {{ entreprise.codePostal }}
              {{ entreprise.ville }}
              {{ entreprise.pays }}
          {% else %}
            <div class="mt-4 mb-3">
                Aucune adresse de facturation enregistrée
            </div>
          {% endif %}
          </div>
{#          {% if entreprise.adresseFacturation != null %}#}
{#            <div class="">#}
{#              <a class="btn btn-cleo" href="{{ path('app_adresse_facturation_edit', {'entrepriseName': entreprise.id, 'id': entreprise.adresseFacturation.id, 'reference': reference }) }}">Modifier l'adresse de facturation</a>#}
{#            </div>#}
{#          {% else %}#}
{#            <div class="">#}
{#              <a class="btn btn-success" href="{{ path('app_adresse_facturation_new', {'entrepriseName': entreprise.id, 'reference': reference}) }}">Ajouter une adresse de facturation</a>#}
{#            </div>#}
{#          {% endif %}#}
      </div>
      <div class="col-md-6">
          <div class="text-center">
              <h3 class="fw-bold mt-3">Ma commande</h3><br>
          </div>
          <hr>
          <div class="order-summary">
          {% set total = null %}
          {% for key, produit in cart %}
          <div class="row {% if key > 0 %} mt-2 {% endif %}">
              <div class="col-8 my-auto">
                  {{ produit.produit.name}}<br>
                  <small>
                      {{ produit.produit.description}} de {{ produit.nom }} {{ produit.prenom }}<br>
                      x {{ produit.quantity }}
                  </small>
              </div>
              <div class="col-2 my-auto">
                  {{((produit.produit.price * produit.quantity) / 100)| number_format(2,',','.')}} €
              </div>
          </div>
          <hr>
          {% set total = total + (produit.produit.price * produit.quantity)%}
          {% endfor %}
          </div>
          <strong>Sous-Total : </strong>{{ ((total) / 100)| number_format(2,',','.') }} €<br>
          {# <strong>Livraison : </strong> {{ (carrier.price / 100)| number_format(2,',','.') }} € #}
          {# <strong>Total : </strong> {{ (((total) / 100) + (carrier.price) / 100)| number_format(2,',','.') }} € #}
          </div>
            <div class="row mt-5">
                <div class="col-12 p-0 d-flex justify-content-evenly">
                  <a class="btn btn-danger btn-lg" href="{{ path('app_order') }}">Retour</a>
                  <a id="checkout-button" class="btn btn-success btn-lg">Payer {{ ((total) / 100)| number_format(2,',','.') }} €</a>
                </div>
            </div>
        </div>
    </div>
<script src="https://js.stripe.com/v3/"></script>
<script>
  var stripe = Stripe("pk_test_51OFcl9B76AFDc7UuXzap3NDozs7ak5jyS2VilJg7m2BN4114kLkxSBWHbp7jjDDpmgLU4UDn8S7ZNhhHlwjYbmbH008zNTlVnM");
  var checkoutButton = document.getElementById("checkout-button");

  checkoutButton.addEventListener("click", function() {

    fetch("/commande/create-session/{{reference}}", {
      method: "POST",
    })

    .then(function (response) {
      return response.json();
    })

    .then(function (session) {
      if (session.error == 'order')
      {
          window.location.replace('{{ path('app_order') }}');
      } else {
          return stripe.redirectToCheckout({ sessionId: session.id});
      }
    })

    .then(function (result) {
      if (result.error){
        alert(result.error.message);
      }

    })
    .catch(function (error){
      console.error("Error:",error);
    })
  });
</script>
{% endblock %}

